#include <Wire.h>

// ================= PCA9685 CONFIG =================
#define PCA9685_ADDR 0x40
#define MODE1        0x00
#define PRESCALE     0xFE
#define LED0_ON_L    0x06

#define ESC_CH       12
#define STEER_CH     3
// =================================================

void write8(uint8_t reg, uint8_t val) {
  Wire.beginTransmission(PCA9685_ADDR);
  Wire.write(reg);
  Wire.write(val);
  Wire.endTransmission();
}

void setPWMFreq(int freq) {
  uint8_t prescale = (25000000UL / (4096 * freq)) - 1;

  write8(MODE1, 0x10);       // sleep
  write8(PRESCALE, prescale);
  write8(MODE1, 0x80);       // restart
  delay(5);
}

void setPWM(uint8_t channel, uint16_t us) {
  uint16_t ticks = (uint32_t)us * 4096 / 20000;
  uint8_t base = LED0_ON_L + 4 * channel;

  write8(base, 0);
  write8(base + 1, 0);
  write8(base + 2, ticks & 0xFF);
  write8(base + 3, ticks >> 8);
}

void setup() {
  Serial.begin(115200);
  Wire.begin();   // Arduino = I2C master

  // Init PCA9685
  write8(MODE1, 0x00);
  delay(10);
  setPWMFreq(50);

  // Safe neutral
  setPWM(ESC_CH, 1000);
  setPWM(STEER_CH, 1500);

  Serial.println("Arduino PCA9685 bridge ready");
}

void loop() {
  if (Serial.available()) {
    String data = Serial.readStringUntil('\n');
    int comma = data.indexOf(',');

    if (comma > 0) {
      int esc_us = data.substring(0, comma).toInt();
      int steer_us = data.substring(comma + 1).toInt();

      esc_us = constrain(esc_us, 1000, 2000);
      steer_us = constrain(steer_us, 1100, 1900);

      setPWM(ESC_CH, esc_us);
      setPWM(STEER_CH, steer_us);
    }
  }
}
