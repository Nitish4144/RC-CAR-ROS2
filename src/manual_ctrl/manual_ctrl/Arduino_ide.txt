#include <Wire.h>
#include <Adafruit_PWMServoDriver.h>

Adafruit_PWMServoDriver pca = Adafruit_PWMServoDriver(0x40);

#define STEER_CH 3 
#define ESC_CH   12
#define PCA_FREQ 50 

// ================= HELPER: µs → PCA TICKS =================
uint16_t usToTicks(int us) {
  // 4096 ticks / 20000us = 0.2048
  return (uint16_t)(us * 0.2048);
}

void setup() {
  Serial.begin(115200);
  Wire.begin();

  pca.begin();
  pca.setPWMFreq(PCA_FREQ);
  
  // Initial safety positions: ESC Stop (1000), Steering Center (1500)
  pca.setPWM(ESC_CH, 0, usToTicks(1500));
  pca.setPWM(STEER_CH, 0, usToTicks(1500));

  Serial.println("BRIDGE_READY");
}

void loop() {
  if (Serial.available()) {
    // Read the incoming raw microsecond string: "1250,1400"
    String data = Serial.readStringUntil('\n');
    data.trim();

    int commaIndex = data.indexOf(',');
    if (commaIndex > 0) {
      // Convert directly to integers since ROS2 is sending microsecond values
      int esc_us = data.substring( 0,commaIndex ).toInt();
      int steer_us = data.substring(commaIndex + 1).toInt();

      // Direct write to PCA (No extra mapping or constraining)
      pca.setPWM(ESC_CH, 0, usToTicks(esc_us));  
      pca.setPWM(STEER_CH, 0, usToTicks(steer_us));
      
      // Verification feedback
     
    }
  }
}
